#name: A workflow for my Hello World App
#on: push
#
#jobs:
#  build:
#    name: Hello world action
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#      - name: Set up JDK 17
#        uses: actions/setup-java@v2
#        with:
#          java-version: '17'
#          distribution: 'adopt'
#      - name: Package with Maven
#        run: mvn package
#      - name: Build Docker Image
#        run: docker build -t devopsimage .
#      - name: Run image
#        run: docker run --name devopscontainer devopsimage
#      - name: view logs
#        run: docker logs devopscontainer
#      - name: Run Docker compose
#        run: docker-compose up --abort-on-container-exit

name: CI for World Database App
on: push

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. Checkout repo + submodules
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3. Build Java app with Maven
      - name: Package with Maven
        run: mvn clean package

      # 4. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. Set up Docker Compose
      - name: Set up Docker Compose
        uses: docker/setup-docker@v2
        with:
          docker-compose-version: 2.21.0

      # 6. Build Docker image for app
      - name: Build Docker image
        run: docker build -t semapp:latest .

      # 7. Start Docker Compose and wait for services
      - name: Start Docker Compose
        run: |
          # Ensure previous containers/volumes are removed
          docker-compose down -v
          # Start containers in detached mode
          docker-compose up -d

      # 8. Wait for MySQL to be ready
      - name: Wait for MySQL
        run: |
          echo "Waiting for MySQL to accept connections..."
          for i in {1..30}; do
            docker exec week08-db-1 mysql -uroot -pexample -e "SELECT 1" && break
            echo "Retry $i/30..."
            sleep 5
          done

      # 9. Show app logs
      - name: Show app logs
        run: docker logs week08-app-1

      # 10. Stop and remove containers after the run
      - name: Tear down
        run: docker-compose down -v
