#name: A workflow for my Hello World App
#on: push
#
#jobs:
#  build:
#    name: Hello world action
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#      - name: Set up JDK 17
#        uses: actions/setup-java@v2
#        with:
#          java-version: '17'
#          distribution: 'adopt'
#      - name: Package with Maven
#        run: mvn package
#      - name: Build Docker Image
#        run: docker build -t devopsimage .
#      - name: Run image
#        run: docker run --name devopscontainer devopsimage
#      - name: view logs
#        run: docker logs devopscontainer
#      - name: Run Docker compose
#        run: docker-compose up --abort-on-container-exit

name: Build and Test with Docker Compose

on: [push]

jobs:
  build:
    name: Build and Run Containers
    runs-on: ubuntu-22.04

    steps:
      # 1️⃣ Check out your repository
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2️⃣ Set up Java (Adoptium Temurin 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3️⃣ Build your JAR file with Maven
      - name: Package with Maven
        run: mvn -B clean package

      # 4️⃣ Set up Docker Buildx (optional but good practice)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5️⃣ Confirm Docker & Compose versions
      - name: Check Docker installation
        run: |
          docker --version
          docker compose version

      # 6️⃣ Build your Docker images (app + db)
      - name: Build Docker Compose services
        run: docker compose build

      # 7️⃣ Run your containers (will exit when app stops)
      - name: Run Docker Compose
        run: docker compose up --abort-on-container-exit

      # 8️⃣ View logs after containers stop (helpful for debugging)
      - name: View logs
        if: always()
        run: docker compose logs

